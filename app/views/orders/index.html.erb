<div class="row">
  <div class="col-md-1"></div>
  <div class="col-md-10">
    <div class="page-header">
      <div class="row">
        <div class="col-md-10">
          <h3>订单信息列表</h3>
        </div>
        <div class="col-md-2">
          <% if can_access("前台客服") %>
            <%= link_to '新建订单', new_order_path, class: "btn btn-default", style: "margin-top: 20px;" %>
          <% end %>
        </div>
      </div>
    </div>
    <table class="table table-bordered table-hover">
      <thead>
        <tr>
          <th>#</th>
          <th>订单编号</th>
          <th>客户名称</th>
          <th>客户地址</th>
          <th>数量合计</th>
          <th>金额合计</th>
          <th>签收人</th>
          <th>业务员</th>
          <th>制单员</th>
          <th>订单状态</th>
          <th>操作</th> 
        </tr>
      </thead>
      <tbody>
        <% @orders.each do |u| %>
          <tr>
            <td><%= u.id %></td>
            <td><%= u.code %></td>
            <td><%= u.customer.name if u.customer %></td>
            <td><%= u.customer.address if u.customer %></td>
            <td><%= u.totle_amount %></td>
            <td><%= u.totle_sum %></td>
            <td><%= u.inceptor %></td>
            <td><%= u.saleman %></td>
            <td><%= u.creator.name if u.creator %></td>
            <td class="state_<%= u.id %>"><%= u.state_cn %></td>
            <td>
              <%= link_to "查看订单详情", order_path(u), class: "btn btn-default" %>
              <%= link_to "更改订单信息", edit_order_path(u), class: "btn btn-default" %>
              
              <% if u.may_submit? && can_access("前台客服") %>
                <button type="button" class="btn btn-default to_pand" p-id="<%= u.id %>">提交审核</button>
              <% end %>
              <% if u.panding? && can_access("财务部门") %>
                <button type="button" class="btn btn-default pand_pass" p-id="<%= u.id %>">审核通过</button>
                <button type="button" class="btn btn-default pand_back" p-id="<%= u.id %>">审核驳回</button>
              <% end %>
              <% if u.may_deliver? && can_access("仓库") %>
                <button type="button" class="btn btn-default to_deliver" p-id="<%= u.id %>">发货</button>
              <% end %>
              <% if u.may_cancel? && can_access("前台客服") %>
                <button type="button" class="btn btn-default to_cancel" p-id="<%= u.id %>">作废</button>
              <% end %>


            </td> 
          </tr>
        <% end %>
      </tbody>
    </table>
    <%= paginate @orders %>
  </div>
  <div class="col-md-1"></div>
</div>

<script type="text/javascript">
  $(document).ready(function(){
    // 点击提交审核按钮
    $("button.to_pand").on("click", function(){
      var pid = $(this).attr("p-id");
      var url = "/orders/"+pid+"/to_pand";
      send_ajax(url, pid);
    });

    // 点击审核通过按钮
    $("button.pand_pass").on("click", function(){
      var pid = $(this).attr("p-id");
      var url = "/orders/"+pid+"/pand_pass";
      send_ajax(url, pid);
    });

    // 点击审核驳回按钮
    $("button.pand_back").on("click", function(){
      var pid = $(this).attr("p-id");
      var url = "/orders/"+pid+"/pand_back";
      send_ajax(url, pid);
    });

    // 点击发货按钮
    $("button.to_deliver").on("click", function(){
      var pid = $(this).attr("p-id");
      var url = "/orders/"+pid+"/to_deliver";
      send_ajax(url, pid);
    });

    // 点击作废按钮
    $("button.to_cancel").on("click", function(){
      var pid = $(this).attr("p-id");
      var url = "/orders/"+pid+"/to_cancel";
      send_ajax(url, pid);
    });

    // 发送ajax请求
    function send_ajax (url, pid) {
      $.ajax({
        type: "POST",
        url: url,
        success: function(data){  
          alert(data.msg);
          // $(".state_"+pid).text(data.state);
          location.reload();
        }
      });
    }
  });
</script>
